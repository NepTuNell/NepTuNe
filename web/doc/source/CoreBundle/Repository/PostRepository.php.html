<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

namespace CoreBundle\Repository;

use CoreBundle\Entity\Post;
use CoreBundle\Entity\User;
use CoreBundle\Entity\Sujet;
use CoreBundle\Entity\PostLike;
use Doctrine\ORM\Query\Expr\Join;
use BackendBundle\Entity\PostControl;
use CoreBundle\Entity\PictureProfile;

/**
 * PostRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PostRepository extends \Doctrine\ORM\EntityRepository
{

    /**
     * Retourne tous les commentaires d'un sujet
     */
    public function fetchAll( $options = array() )
    {

        $queryBuilder   = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        $countLike      = $this-&gt;countLike();
        $countDisLike   = $this-&gt;countDisLike();

        if ( array_key_exists('user', $options) &amp;&amp; 'anon.' !== $options['user'] ) {
                

            /***********************************************************************************
             *              Requ&ecirc;te utilis&eacute;e par les utilisateurs connect&eacute;s
             **********************************************************************************/
            $result = $queryBuilder -&gt;select('p.id, p.commentaire, p.date, u.username, u.id as id_user, pp.pictureName, pp.id as pictureID, pp.pictureExtension, pc.id as reclamationID')
                                    -&gt;addSelect('('.$countLike.') as nbLike')
                                    -&gt;addSelect('('.$countDisLike.') as nbDisLike')
                                    -&gt;from(Post::class, 'p') 
                                    -&gt;where('p.sujet = :sujet')
                                    -&gt;leftJoin(
                                        PictureProfile::class, 
                                        'pp',
                                        \Doctrine\ORM\Query\Expr\Join::WITH,
                                        'pp.user = p.user'  
                                    )
                                    -&gt;leftJoin(
                                        PostControl::class, 
                                        'pc',
                                        \Doctrine\ORM\Query\Expr\Join::WITH,
                                        'pc.user = :user AND pc.post = p.id',
                                    )
                                    -&gt;innerJoin(User::class, 'u')
                                    -&gt;andWhere('p.user = u.id')
                                    -&gt;setParameters([
                                        'sujet' =&gt; $options['sujet'],
                                        'user'  =&gt; $options['user']
                                    ])
                                    -&gt;orderBy('p.date', 'ASC')
                                    -&gt;getQuery();  
                                    
        } else {

            /***********************************************************************************
             *              Requ&ecirc;te utilis&eacute;e par les utilisateurs non connect&eacute;s
             **********************************************************************************/
            $result = $queryBuilder -&gt;select('p.id, p.commentaire, p.date, u.username, u.id as id_user, pp.pictureName, pp.id as pictureID, pp.pictureExtension')
                                    -&gt;addSelect('('.$countLike.') as nbLike')
                                    -&gt;addSelect('('.$countDisLike.') as nbDisLike')
                                    -&gt;from(Post::class, 'p') 
                                    -&gt;where('p.sujet = :sujet')
                                    -&gt;leftJoin(
                                        PictureProfile::class, 
                                        'pp',
                                        \Doctrine\ORM\Query\Expr\Join::WITH,
                                        'pp.user = p.user'        
                                    )
                                    -&gt;innerJoin(User::class, 'u')
                                    -&gt;andWhere('p.user = u.id')
                                    -&gt;setParameters([
                                        'sujet' =&gt; $options['sujet']
                                    ])
                                    -&gt;orderBy('p.date', 'ASC')
                                    -&gt;getQuery();
                                     
        }   
      
        return $result-&gt;getResult();

    }
    
    /**
     * Retourne les commentaires signal&eacute;s en fonction des filtres s&eacute;lectionn&eacute;s
     */
    public function fetchAllAdmin( $options = array() )
    {

        $queryBuilder     = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        $countLike        = $this-&gt;countLike();
        $countDisLike     = $this-&gt;countDisLike();
        $countSignalement = $this-&gt;countSignalement();

        if ( $options['sujet'] != 0 ) {

            /***********************************************************************************
             *      Requ&ecirc;te utilis&eacute;e par les admins pour voir les commentaires signal&eacute;s
             **********************************************************************************/
            $result = $queryBuilder -&gt;select('p.id, p.commentaire, p.date, u.username, u.id as id_user, pp.pictureName, pp.id as pictureID, pp.pictureExtension, pc.id as reclamationID, s.id as sujetID, s.libelle as sujetLibelle')
                                    -&gt;addSelect('('.$countLike.') as nbLike')
                                    -&gt;addSelect('('.$countDisLike.') as nbDisLike')
                                    -&gt;addSelect('('.$countSignalement.') as nbSignalement')
                                    -&gt;from(Post::class, 'p') 
                                    -&gt;where('p.sujet = :sujet')
                                    -&gt;leftJoin(PictureProfile::class, 'pp', Join::WITH, 'pp.user = p.user')
                                    -&gt;innerJoin(PostControl::class, 'pc', Join::WITH, 'pc.post = p.id')
                                    -&gt;innerJoin(User::class, 'u' , Join::WITH, 'p.user = u.id')
                                    -&gt;innerJoin(Sujet::class, 's', Join::WITH, 's.id = p.sujet')
                                    -&gt;setParameters([
                                        'sujet' =&gt; $options['sujet']
                                    ]); 

        } else {

            /***********************************************************************************
             *      Requ&ecirc;te utilis&eacute;e par les admins pour voir les commentaires signal&eacute;s
             **********************************************************************************/
            $result = $queryBuilder -&gt;select('p.id, p.commentaire, p.date, u.username, u.id as id_user, pp.pictureName, pp.id as pictureID, pp.pictureExtension, s.id as sujetID, s.libelle as sujetLibelle')
                                    -&gt;addSelect('('.$countLike.') as nbLike')
                                    -&gt;addSelect('('.$countDisLike.') as nbDisLike')
                                    -&gt;addSelect('('.$countSignalement.') as nbSignalement')
                                    -&gt;from(Post::class, 'p') 
                                    -&gt;leftJoin(PictureProfile::class, 'pp', Join::WITH, 'pp.user = p.user')
                                    -&gt;innerJoin(PostControl::class, 'pc', Join::WITH, 'p.id = pc.post')
                                    -&gt;innerJoin(User::class, 'u' , Join::WITH, 'p.user = u.id')
                                    -&gt;innerJoin(Sujet::class, 's', Join::WITH, 's.id = p.sujet');

        }

   
        /********************************************************* 
         *          Construction de la clause OrderBy
         ********************************************************/
        if ( $options['orderByDate'] == 1 || $options['orderBySignalement'] == 1 ) {

            if ( $options['orderByDate'] == 1 ) {
                $result-&gt;addOrderBy('p.date', 'ASC');
            } else {
                $result-&gt;addOrderBy('p.date', 'DESC');
            }

            if ( $options['orderBySignalement'] == 1 ) {
                $result-&gt;addOrderBy('nbSignalement', 'ASC');
            } else {
                $result-&gt;addOrderBy('nbSignalement', 'DESC');
            }

        }  else {
            $result-&gt;orderBy('p.date', 'DESC');
            $result-&gt;addOrderBy('nbSignalement', 'DESC');
        }

        return $result-&gt;getQuery()-&gt;getResult();

    }

    /**
     * Retourne la requ&ecirc;te SQL qui s&eacute;lectionne le nombre de like d'un commentaire
     */
    public function countLike()
    {

        $queryBuilder = $this-&gt;getEntityManager()-&gt;createQueryBuilder();

        $result = $queryBuilder -&gt;select('COUNT(pl1)')
                                -&gt;from(PostLike::class, 'pl1')
                                -&gt;where('pl1.post = p.id AND pl1.like = true')
                                -&gt;getDQL();

        return $result;

    }

    /**
     * Retourne la requ&ecirc;te SQL qui s&eacute;lectionne le nombre de dislike d'un commentaire
     */
    public function countDisLike()
    {

        $queryBuilder = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  

        $result = $queryBuilder -&gt;select('COUNT(pl2)')
                                -&gt;from(PostLike::class, 'pl2')
                                -&gt;where('pl2.post = p.id AND pl2.like = false')
                                -&gt;getDQL();

        return $result;

    }

    /**
     *  Retourne la requ&ecirc;te SQL qui s&eacute;lectionne le nombre de signalement d'un commentaire
     */
    public function countSignalement()
    {

        $queryBuilder = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  

        $result = $queryBuilder -&gt;select('COUNT(cs)')
                                -&gt;from(PostControl::class, 'cs')
                                -&gt;where('cs.post = p.id')
                                -&gt;getDQL();

        return $result;

    }
    

}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>