<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

namespace CoreBundle\Repository;

use CoreBundle\Entity\Post;
use CoreBundle\Entity\User;
use CoreBundle\Entity\Sujet;
use BackendBundle\Entity\Theme;
use Doctrine\ORM\Query\Expr\Join;
 

/**
 * SujetRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class SujetRepository extends \Doctrine\ORM\EntityRepository
{

    /**
     * Retourne la requ&ecirc;te SQL qui renvoie le nombre de commentaire pour un sujet (m&eacute;thode 1)
     */
    public function countPostQuery()
    {

        $countQuery = $this-&gt;getEntityManager()-&gt;createQueryBuilder();

        $countPost = $countQuery-&gt;select('COUNT(p)')
                                -&gt;from(Post::class, 'p')
                                -&gt;where('p.sujet = u.id')
                                -&gt;getDQL();

        return $countPost;

    }

    /**
     * Recherche tous les sujets dans un th&egrave;me ou une section sp&eacute;cifique
     */
    public function fetchAllSubject($options = array())
    {
  
        $queryBuilder  = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        $countPost     = $this-&gt;countPostQuery();

        if (array_key_exists('section', $options)) {
            
            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.section = :section')
                                    -&gt;setParameters([
                                        'section'   =&gt; $options['section']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        } else {

            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')                             
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.theme = :theme')
                                    -&gt;setParameters([
                                        'theme'   =&gt; $options['theme']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        }

        return $result-&gt;getArrayResult();
     
    }

    /**
     * Recherche d'un ou plusieurs sujet(s) dans un th&egrave;me ou une section sp&eacute;cifique option contient
     */
    public function fetchSubjectByLibelleContains($options = array())
    {

        $queryBuilder  = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        $countPost     = $this-&gt;countPostQuery();

        if (array_key_exists('section', $options)) {
            
            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.libelle LIKE :libelle AND u.section = :section')
                                    -&gt;setParameters([
                                        'libelle' =&gt; &quot;%&quot;.$options['libelle'].&quot;%&quot;, 
                                        'section'   =&gt; $options['section']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        } else {

            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.libelle LIKE :libelle AND u.theme = :theme')
                                    -&gt;setParameters([
                                        'libelle' =&gt; &quot;%&quot;.$options['libelle'].&quot;%&quot;, 
                                        'theme'   =&gt; $options['theme']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        }

        return $result-&gt;getArrayResult();
     
    }

    /**
     * Recherche d'un ou plusieurs sujet(s) dans un th&egrave;me ou une section sp&eacute;cifique option commence par
     */
    public function fetchSubjectByLibelleBegin($options = array())
    {

        $queryBuilder  = $this-&gt;getEntityManager()-&gt;createQueryBuilder(); 
        $countPost     = $this-&gt;countPostQuery();
        
        if (array_key_exists('section', $options)) {
            
            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.libelle LIKE :libelle AND u.section = :section')
                                    -&gt;setParameters([
                                        'libelle' =&gt; $options['libelle'].&quot;%&quot;, 
                                        'section'   =&gt; $options['section']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        } else {

            $result = $queryBuilder -&gt;select('u.id, u.libelle, u.date, s.id as id_user')
                                    -&gt;addSelect('('.$countPost.') as nbPost')
                                    -&gt;from(Sujet::class, 'u')
                                    -&gt;innerJoin(User::class, 's', Join::WITH, 'u.user = s.id')
                                    -&gt;where('u.libelle LIKE :libelle AND u.theme = :theme')
                                    -&gt;setParameters([
                                        'libelle' =&gt; $options['libelle'].&quot;%&quot;, 
                                        'theme'   =&gt; $options['theme']
                                    ])
                                    -&gt;orderBy('u.date', 'DESC')
                                    -&gt;getQuery();

        }

        return $result-&gt;getArrayResult();
     
    }

    /********************************
     *        PAGE D'ACCUEIL
     *******************************/
    
    /**
     * Recherche des sujets les plus r&eacute;cents
     */
    public function fetchLastSubjects()
    {

        $queryBuilder = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        
        $result = $queryBuilder -&gt;setMaxResults(3)
                                -&gt;select('s')
                                -&gt;from(Sujet::class, 's')
                                -&gt;innerJoin(User::class, 'u')
                                -&gt;where('s.user = u.id')
                                -&gt;orderBy('s.date', 'DESC')
                                -&gt;getQuery()
                                -&gt;getResult();
                                
        return $result;
     
    }

    /**
     * Recherche des sujets les plus r&eacute;cents
     */
    public function fetchMostViewSubjects()
    {

        $queryBuilder = $this-&gt;getEntityManager()-&gt;createQueryBuilder();  
        $countPost    = $this-&gt;countPostQuery2();

        $result = $queryBuilder -&gt;setMaxResults(3)
                                -&gt;select('s.id, s.libelle, s.date, u.username')
                                -&gt;addSelect('('.$countPost.') as nbPost')
                                -&gt;from(Sujet::class, 's')
                                -&gt;innerJoin(User::class, 'u')
                                -&gt;where('s.user = u.id')
                                -&gt;orderBy('nbPost', 'DESC')
                                -&gt;getQuery()
                                -&gt;getResult();
                                
        return $result;
     
    }

    /**
     * Retourne la requ&ecirc;te SQL qui renvoie le nombre de commentaire pour un sujet (m&eacute;thode 2)
     */
    public function countPostQuery2()
    {

        $countQuery = $this-&gt;getEntityManager()-&gt;createQueryBuilder();

        $countPost = $countQuery-&gt;select('COUNT(p)')
                                -&gt;from(Post::class, 'p')
                                -&gt;where('p.sujet = s.id')
                                -&gt;getDQL();

        return $countPost;

    }

    /**
     * Retourne la requ&ecirc;te SQL qui renvoie le nombre de commentaire pour un sujet (m&eacute;thode 3)
     */
    public function countPostQuery3(Sujet $sujet)
    {

        $countQuery = $this-&gt;getEntityManager()-&gt;createQueryBuilder();

        $countPost = $countQuery-&gt;select('COUNT(p)')
                                -&gt;from(Post::class, 'p')
                                -&gt;innerJoin(Sujet::class, 's', JOIN::WITH, 's.id = :sujet')
                                -&gt;where('p.sujet = s.id')
                                -&gt;setParameters([
                                    'sujet' =&gt; $sujet
                                ])
                                -&gt;getQuery();

        return $countPost-&gt;getScalarResult();

    }

}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>